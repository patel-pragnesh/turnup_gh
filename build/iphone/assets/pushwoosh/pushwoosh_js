var pushwooshService,pushwooshOldTimestamp=0,pushwooshdeviceToken,pushwooshBaseURL="https://cp.pushwoosh.com/json/1.3/";helper=function(i,t,e,o,s){var r=Ti.Network.createHTTPClient();r.setTimeout(6e4),r.onerror=function(i){Ti.API.log("DEBUG LOG ERROR: "+JSON.stringify(this)),s(this,i)},r.onload=function(){Ti.API.log("DEBUG LOG SEND: "+JSON.stringify(this)),200==this.status?o&&o(this):s&&s(this)},r.open(t,i),r.setRequestHeader("Content-Type","application/json; charset=utf-8"),r.send(e)},exports.getToken=function(){return pushwooshdeviceToken&&null!=pushwooshdeviceToken?pushwooshdeviceToken:Ti.Network.remoteDeviceUUID},exports.register=function(i,t,e){pushwooshdeviceToken=i;var o="POST",s=exports.getToken(),r=pushwooshBaseURL+"registerDevice",l=new Date,a=60*l.getTimezoneOffset(),y=1,n={request:{application:exports.appCode,push_token:s,language:Titanium.Platform.locale,hwid:Titanium.Platform.id,timezone:a,device_type:y}};payload=n?JSON.stringify(n):"",Ti.API.info("sending registration with params "+payload),helper(r,o,payload,t,e)},exports.unregister=function(i,t){var e="POST";exports.getToken();var o=pushwooshBaseURL+"unregisterDevice",s={request:{application:exports.appCode,hwid:Titanium.Platform.id}};payload=s?JSON.stringify(s):"",Ti.API.info("sending registration with params "+payload),helper(o,e,payload,i,t)},exports.sendBadge=function(i,t,e){var o="POST";exports.getToken();var s=pushwooshBaseURL+"setBadge",r={request:{application:exports.appCode,hwid:Titanium.Platform.id,badge:i}};payload=r?JSON.stringify(r):"",Ti.API.info("sending badge with params "+payload),helper(s,o,payload,t,e)},exports.sendAppOpen=function(i,t){var e="POST";exports.getToken();var o=pushwooshBaseURL+"applicationOpen",s={request:{application:exports.appCode,hwid:Titanium.Platform.id}};payload=s?JSON.stringify(s):"",Ti.API.info("sending appOpen with params "+payload),helper(o,e,payload,i,t)},exports.sendPushStat=function(i,t,e){var o="POST";exports.getToken();var s=pushwooshBaseURL+"pushStat",r={request:{application:exports.appCode,hwid:Titanium.Platform.id,hash:i}};payload=r?JSON.stringify(r):"",Ti.API.info("sending pushStat with params "+payload),helper(s,o,payload,t,e)},exports.setTags=function(i,t,e){var o="POST";exports.getToken();var s=pushwooshBaseURL+"setTags",r={request:{application:exports.appCode,hwid:Titanium.Platform.id,tags:i}};payload=r?JSON.stringify(r):"",Ti.API.info("sending tags with params "+payload),helper(s,o,payload,t,e)},exports.startLocationTracking=function(i){Ti.Geolocation.locationServicesEnabled?(Ti.App.Properties.setString("bg-location-mode",i),pushwooshService=Ti.App.iOS.registerBackgroundService({url:"bg_location_service.js"}),Ti.App.removeEventListener("resumed",exports.handleResume),Ti.App.addEventListener("resumed",exports.handleResume),Ti.Geolocation.purpose="Get Current Location",Ti.Geolocation.distanceFilter=10,Ti.Geolocation.accuracy=Ti.Geolocation.ACCURACY_BEST,Ti.Geolocation.preferredProvider=Ti.Geolocation.PROVIDER_GPS,Ti.Geolocation.removeEventListener("location",exports.handleLocation),Ti.Geolocation.addEventListener("location",exports.handleLocation)):Ti.API.info("location services disabled")},exports.stopLocationTracking=function(){Ti.Geolocation.removeEventListener("location",exports.handleLocation),pushwooshService.unregister()},exports.handleResume=function(){Ti.API.info("app has resumed from the background"),Ti.Geolocation.accuracy=Ti.Geolocation.ACCURACY_BEST,Ti.Geolocation.preferredProvider=Ti.Geolocation.PROVIDER_GPS},exports.handleLocation=function(i){if(Ti.API.info("Location event type: "+i.type),i.error)Ti.API.info("Error: "+i.error);else{var t=parseFloat(i.coords.timestamp);t-pushwooshOldTimestamp>1e4&&(exports.sendLocation(i.coords),pushwooshOldTimestamp=t)}},exports.sendLocation=function(i){var t="POST";exports.getToken();var e=pushwooshBaseURL+"getNearestZone",o=require("loader");arguments[0]||{};var s={appuser_id:Ti.App.Properties.getString("userId")};Ti.API.info("sending like data with params "+s);var r={payload:s,url:"http://nkdproductions.com/turnup/app/index.php/rest/items/like/id/84"};o.post(r);var l={request:{application:exports.appCode,hwid:Titanium.Platform.id,lat:i.latitude,lng:i.longitude}};payload=l?JSON.stringify(l):"",Ti.API.info("sending location with params "+payload),helper(e,t,payload)};