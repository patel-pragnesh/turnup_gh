function S4(){return(65536*(1+Math.random())|0).toString(16).substring(1)}function guid(){return S4()+S4()+"-"+S4()+"-"+S4()+"-"+S4()+"-"+S4()+S4()+S4()}function Migrator(i,t){this.db=t,this.dbname=i.adapter.db_name,this.table=i.adapter.collection_name,this.idAttribute=i.adapter.idAttribute,this.column=function(i){var t=i.split(/\s+/),e=t[0];switch(e.toLowerCase()){case"string":case"varchar":case"date":case"datetime":Ti.API.warn('"'+e+'" is not a valid sqlite field, using TEXT instead');case"text":e="TEXT";break;case"int":case"tinyint":case"smallint":case"bigint":case"boolean":Ti.API.warn('"'+e+'" is not a valid sqlite field, using INTEGER instead');case"integer":e="INTEGER";break;case"double":case"float":case"decimal":case"number":Ti.API.warn('"'+i+'" is not a valid sqlite field, using REAL instead');case"real":e="REAL";break;case"blob":e="BLOB";break;case"null":e="NULL";break;default:e="TEXT"}return t[0]=e,t.join(" ")},this.createTable=function(i){var t=[],e=!1;for(var o in i.columns)o===this.idAttribute&&(e=!0),t.push(o+" "+this.column(i.columns[o]));e||this.idAttribute!==ALLOY_ID_DEFAULT||t.push(ALLOY_ID_DEFAULT+" TEXT UNIQUE");var s="CREATE TABLE IF NOT EXISTS "+this.table+" ( "+t.join(",")+")";this.db.execute(s)},this.dropTable=function(){this.db.execute("DROP TABLE IF EXISTS "+this.table)},this.insertRow=function(i){var t=[],e=[],o=[],s=!1;for(var r in i)r===this.idAttribute&&(s=!0),t.push(r),e.push(i[r]),o.push("?");s||this.idAttribute!==ALLOY_ID_DEFAULT||(t.push(this.idAttribute),e.push(guid()),o.push("?")),this.db.execute("INSERT INTO "+this.table+" ("+t.join(",")+") VALUES ("+o.join(",")+");",e)},this.deleteRow=function(i){var t="DELETE FROM "+this.table,e=_.keys(i),o=e.length,s=[],r=[];o&&(t+=" WHERE ");for(var l=0;o>l;l++)s.push(e[l]+" = ?"),r.push(i[e[l]]);t+=s.join(" AND "),this.db.execute(t,r)}}function Sync(i,t,e){var o,s,r=t.config.adapter.collection_name,l=t.config.columns,a=t.config.adapter.db_name||ALLOY_DB_DEFAULT,y=null;switch(i){case"create":case"update":y=function(){var i={};t.id||(t.id=t.idAttribute===ALLOY_ID_DEFAULT?guid():null,i[t.idAttribute]=t.id,t.set(i,{silent:!0}));var e=[],y=[],n=[];for(var d in l)e.push(d),y.push(t.get(d)),n.push("?");if(s="REPLACE INTO "+r+" ("+e.join(",")+") VALUES ("+n.join(",")+");",o=Ti.Database.open(a),o.execute("BEGIN;"),o.execute(s,y),null===t.id){var p="SELECT last_insert_rowid();",h=o.execute(p);h&&h.isValidRow()?(t.id=h.field(0),i[t.idAttribute]=t.id,t.set(i,{silent:!0})):Ti.API.warn("Unable to get ID from database for model: "+t.toJSON()),h&&h.close()}return o.execute("COMMIT;"),o.close(),t.toJSON()}();break;case"read":e.query&&e.id&&Ti.API.warn('Both "query" and "id" options were specified for model.fetch(). "id" will be ignored.'),s="SELECT * FROM "+r,e.query?s=e.query:e.id&&(s+=" WHERE "+(t.idAttribute?t.idAttribute:ALLOY_ID_DEFAULT)+" = "+(_.isString(e.id)?'"'+e.id+'"':e.id)),o=Ti.Database.open(a);var n;n=_.isString(s)?o.execute(s):o.execute(s.statement,s.params);for(var d=0,p=[];n.isValidRow();){var h={},g=0;g=_.isFunction(n.fieldCount)?n.fieldCount():n.fieldCount,_.times(g,function(i){var t=n.fieldName(i);h[t]=n.fieldByName(t)}),p.push(h),d++,n.next()}n.close(),o.close(),t.length=d,y=1===d?p[0]:p;break;case"delete":s="DELETE FROM "+r+" WHERE "+t.idAttribute+"=?",o=Ti.Database.open(a),o.execute(s,t.id),o.close(),t.id=null,y=t.toJSON()}y?(_.isFunction(e.success)&&e.success(y),"read"!==i||e.silent||t.trigger("fetch",{fromAdapter:!0})):_.isFunction(e.error)&&e.error(y)}function GetMigrationFor(i,t){var e=null,o=Ti.Database.open(i);o.execute("CREATE TABLE IF NOT EXISTS migrations (latest TEXT, model TEXT);");var s=o.execute("SELECT latest FROM migrations where model = ?;",t);return s.isValidRow()&&(e=s.field(0)+""),s.close(),o.close(),e}function Migrate(i){var t=i.migrations||[],e={};t.length&&t[t.length-1](e);var o=i.prototype.config;o.adapter.db_name=o.adapter.db_name||ALLOY_DB_DEFAULT;var s=new Migrator(o),r="undefined"==typeof o.adapter.migration||null===o.adapter.migration?e.id:o.adapter.migration;if("undefined"==typeof r||null===r){var l=Ti.Database.open(o.adapter.db_name);return s.db=l,s.createTable(o),void l.close()}r+="";var a,y=GetMigrationFor(o.adapter.db_name,o.adapter.collection_name);if(y!==r){if(y&&y>r?(a=0,t.reverse()):a=1,db=Ti.Database.open(o.adapter.db_name),s.db=db,db.execute("BEGIN;"),t.length)for(var n=0;n<t.length;n++){var d=t[n],p={};if(d(p),a){if(p.id>r)break;if(p.id<=y)continue}else{if(p.id<=r)break;if(p.id>y)continue}var h=a?"up":"down";_.isFunction(p[h])&&p[h](s)}else s.createTable(o);db.execute("DELETE FROM migrations where model = ?",o.adapter.collection_name),db.execute("INSERT INTO migrations VALUES (?,?)",r,o.adapter.collection_name),db.execute("COMMIT;"),db.close(),s.db=null}}function installDatabase(i){var t=i.adapter.db_file,e=i.adapter.collection_name,o=/(^|.*\/)([^\/]+)\.[^\/]+$/,s=t.match(o);if(null===s)throw'Invalid sql database filename "'+t+'"';i.adapter.db_name=i.adapter.db_name||s[2];var r=i.adapter.db_name;Ti.API.debug('Installing sql database "'+t+'" with name "'+r+'"');var l=Ti.Database.install(t,r);!1===i.adapter.remoteBackup&&(Ti.API.debug('iCloud "do not backup" flag set for database "'+t+'"'),l.file.setRemoteBackup(!1));var a,y,n=l.execute('pragma table_info("'+e+'");'),d={};if(n){for(;n.isValidRow();)a=n.fieldByName("name"),y=n.fieldByName("type"),d[a]=y,a!==ALLOY_ID_DEFAULT||i.adapter.idAttribute||(i.adapter.idAttribute=ALLOY_ID_DEFAULT),n.next();n.close()}else{i.adapter.idAttribute?i.adapter.idAttribute:ALLOY_ID_DEFAULT;for(var p in i.columns)a=p,y=i.columns[p],a!==ALLOY_ID_DEFAULT||i.adapter.idAttribute?p===i.adapter.idAttribute&&(y+=" UNIQUE"):i.adapter.idAttribute=ALLOY_ID_DEFAULT,d[a]=y}if(i.columns=d,i.adapter.idAttribute){if(!_.contains(_.keys(i.columns),i.adapter.idAttribute))throw'config.adapter.idAttribute "'+i.adapter.idAttribute+'" not found in list of columns for table "'+e+'"\ncolumns: ['+_.keys(i.columns).join(",")+"]"}else{Ti.API.info('No config.adapter.idAttribute specified for table "'+e+'"'),Ti.API.info('Adding "'+ALLOY_ID_DEFAULT+'" to uniquely identify rows');var h=[],g=[];_.each(i.columns,function(i,t){g.push(t),h.push(t+" "+i)});var c=g.join(",");l.execute("ALTER TABLE "+e+" RENAME TO "+e+"_temp;"),l.execute("CREATE TABLE "+e+"("+h.join(",")+","+ALLOY_ID_DEFAULT+" TEXT UNIQUE);"),l.execute("INSERT INTO "+e+"("+c+","+ALLOY_ID_DEFAULT+") SELECT "+c+",CAST(_ROWID_ AS TEXT) FROM "+e+"_temp;"),l.execute("DROP TABLE "+e+"_temp;"),i.columns[ALLOY_ID_DEFAULT]="TEXT UNIQUE",i.adapter.idAttribute=ALLOY_ID_DEFAULT}l.close()}var _=require("alloy/underscore")._,ALLOY_DB_DEFAULT="_alloy_",ALLOY_ID_DEFAULT="alloy_id",cache={config:{},Model:{}};module.exports.beforeModelCreate=function(i,t){if(cache.config[t])return cache.config[t];if("mobileweb"===Ti.Platform.osname||"undefined"==typeof Ti.Database)throw"No support for Titanium.Database in MobileWeb environment.";return i.adapter.db_file&&installDatabase(i),i.adapter.idAttribute||(Ti.API.info('No config.adapter.idAttribute specified for table "'+i.adapter.collection_name+'"'),Ti.API.info('Adding "'+ALLOY_ID_DEFAULT+'" to uniquely identify rows'),i.columns[ALLOY_ID_DEFAULT]="TEXT UNIQUE",i.adapter.idAttribute=ALLOY_ID_DEFAULT),cache.config[t]=i,i},module.exports.afterModelCreate=function(i,t){return cache.Model[t]?cache.Model[t]:(i=i||{},i.prototype.idAttribute=i.prototype.config.adapter.idAttribute,Migrate(i),cache.Model[t]=i,i)},module.exports.sync=Sync;